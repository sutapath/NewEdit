<template>
    <AuthenticatedLayout>

        <Head title="Create Scholar Inform" />

        <div class="max-w-7xl mx-auto py-4 mt-20 px-10">
            <div class="px-4 text-white dark:text-gray-100 flex justify-between items-center">
                <div class="py-2 text-gray-800 rounded-t-lg text-xl font-bold">
                    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                </div>
                <div class="flex-1 mr-3 ml-3">
                    <hr class="border-t border-gray-300" />
                </div>
                <div class="flex justify-end space-x-4">
                    <Link href="#" class="custom-button-danger" @click.prevent="confirmCancel">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </Link>

                    <PrimaryButton class="custom-button-success" :disabled="form.processing" @click="handleSubmit">
                        <span v-if="form.processing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        <span v-else>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </PrimaryButton>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-2 px-10">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <form @submit.prevent="handleSubmit" enctype="multipart/form-data">
                    <input type="hidden" name="_method" value="PUT" />

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-5">
                        <div>
                            <InputLabel for="scholar_name" value="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤" />
                            <TextInput id="scholar_name" type="text" class="mt-1 block w-full"
                                v-model="form.scholar_name" autofocus />
                            <span v-if="errorMessages.scholar_name" class="text-red-600">{{ errorMessages.scholar_name
                                }}</span>
                        </div>

                        <div>
                            <InputLabel for="type" value="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤" />
                            <select id="type" class="mt-1 block w-full" v-model="form.type">
                                <option value="" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                                <option value="1">
                                    ‡∏ó‡∏∏‡∏ô‡∏á‡∏î‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                                </option>
                                <option value="0">‡∏ó‡∏∏‡∏ô‡πÄ‡∏û‡∏ä‡∏£‡∏≠‡∏¥‡∏ô‡∏ó‡∏ô‡∏¥‡∏•</option>
                            </select>
                            <span v-if="errorMessages.type" class="text-red-600">{{ errorMessages.type }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-5">
                        <div>
                            <InputLabel for="apply_date" value="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£" />
                            <TextInput id="apply_date" type="date" class="mt-1 block w-full"
                                v-model="form.apply_date" />
                            <span v-if="errorMessages.apply_date" class="text-red-600">{{ errorMessages.apply_date
                                }}</span>
                        </div>
                        <div>
                            <InputLabel for="due_date" value="‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î" />
                            <TextInput id="due_date" type="date" class="mt-1 block w-full" v-model="form.due_date" />
                            <span v-if="errorMessages.due_date" class="text-red-600">{{ errorMessages.due_date }}</span>
                        </div>
                        <div>
                            <InputLabel for="status" value="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" />
                            <select id="status" class="mt-1 block w-full" v-model="form.status">
                                <option value="" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="0">‡∏õ‡∏¥‡∏î</option>
                                <option value="1">‡πÄ‡∏õ‡∏¥‡∏î</option>
                            </select>
                            <span v-if="errorMessages.status" class="text-red-600">{{ errorMessages.status }}</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <InputLabel for="description" value="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" />
                        <textarea id="description"
                            class="mt-1 block w-full border rounded-md border-gray-300 focus:border-gray-500 focus:ring focus:ring-gray-200 focus:ring-opacity-50"
                            v-model="form.description"></textarea>
                        <span v-if="errorMessages.description" class="text-red-600">{{ errorMessages.description
                            }}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-5">
                        <div>
                            <InputLabel for="link" value="‡∏•‡∏¥‡∏á‡∏Ñ‡πå" />
                            <TextInput id="link" type="text" class="mt-1 block w-full" v-model="form.link" />
                            <span v-if="errorMessages.link" class="text-red-600">{{ errorMessages.link }}</span>
                        </div>
                        <div>
                            <InputLabel for="file" value="‡πÑ‡∏ü‡∏•‡πå" />
                            <TextInput id="file" type="file" class="mt-1 block w-full py-1 px-2"
                                @change="handleFileChange" />
                            <span v-if="errorMessages.file" class="text-red-600">{{ errorMessages.file }}</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </AuthenticatedLayout>
</template>

<script setup>
import { ref } from "vue";
import { useForm, usePage, router } from "@inertiajs/vue3";
import { Head, Link } from "@inertiajs/vue3";
import AuthenticatedLayout from "@/Layouts/AuthenticatedLayout.vue";
import TextInput from "@/Components/TextInput.vue";
import InputLabel from "@/Components/InputLabel.vue";
import PrimaryButton from "@/Components/PrimaryButton.vue";
import Swal from "sweetalert2";

const { props } = usePage();

const form = useForm({
    scholar_name: "",
    type: "",
    apply_date: "",
    due_date: "",
    status: "",
    description: "",
    link: "",
    officer_code: props.auth.user.id,
    file: null,
});

const errorMessages = ref({
    scholar_name: "",
    type: "",
    apply_date: "",
    due_date: "",
    status: "",
    description: "",
    link: "",
    file: "",
});
const confirmCancel = () => {
    Swal.fire({
        title: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
        text: "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    }).then((result) => {
        if (result.isConfirmed) {
            router.visit(route("scholarships.index"));
        }
    });
};

const validateForm = () => {
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô
    Object.keys(errorMessages.value).forEach((key) => {
        errorMessages.value[key] = "";
    });

    if (!form.scholar_name) {
        errorMessages.value.scholar_name = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤";
    }
    if (!form.type) {
        errorMessages.value.type = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤";
    }
    if (!form.apply_date) {
        errorMessages.value.apply_date = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£";
    }
    if (!form.due_date) {
        errorMessages.value.due_date = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î";
    }
    if (!form.status) {
        errorMessages.value.status = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
    }
    if (!form.description) {
        errorMessages.value.description = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢";
    }
    if (!form.link) {
        errorMessages.value.link = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Link ";
    }
    if (!form.file) {
        errorMessages.value.file = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";
    }
};

const handleFileChange = (e) => {
    form.file = e.target.files[0];
};

const handleSubmit = () => {
    validateForm();

    // Log the error messages before validating form
    console.log("Error messages before submission:", errorMessages.value);

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    if (Object.values(errorMessages.value).some((error) => error)) {
        console.log("Form has validation errors. Form will not be submitted.");
        return;
    }

    console.log("Form data before submission:", form);

    form.post(route("scholarships.store"), {
        onSuccess: () => {
            // Log success
            console.log("Form submission success!");

            // Show success notification using SweetAlert2
            Swal.fire({
                title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
                icon: "success",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
                confirmButtonColor: "#3085d6", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
            });

            const message = `${form.status === "0" ? "‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£" : "‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£"}
‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏ô: **${form.scholar_name}**

üóìÔ∏è **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£**: ${form.apply_date}  
üìÖ **‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£**: ${form.due_date}

üìÑ **‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î**:  
${form.description}

üåê **‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£**: [‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà](${form.link})`;

            sendLineNotification(
                props.userLineNotify.map((notify) => notify.user_id),
                message
            );
        },
        onError: () => {
            // Log error
            console.log("Form submission failed. Error occurred.");

            // Show error notification using SweetAlert2
            Swal.fire({
                title: "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
                text: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
                icon: "error",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
                confirmButtonColor: "#d33", // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
            });
        },
    });
};


const sendLineNotification = (userIds, message) => {
    const token = document
        .querySelector('meta[name="csrf-token"]')
        ?.getAttribute("content");

    if (!token) {
        console.error("CSRF token not found");
        return;
    }

    userIds.forEach((userId) => {
        fetch(route("line.notify", { userId }), {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": token,
            },
            body: JSON.stringify({ message }),
        })
            .then((response) => response.json())
            .then((data) => {
                console.log(
                    "Line Notify Response for userId",
                    userId,
                    ":",
                    data
                );
            })
            .catch((error) => {
                console.error("Error for userId", userId, ":", error);
            });
    });
};
</script>